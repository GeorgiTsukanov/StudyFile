#include <fstream>
#include <iostream>
#include <windows.h>

using namespace std;

struct Person {
    int weight;
    int height;
    char name[25];
}pers;

int main(){
    setlocale(LC_ALL, "rus");

    int answer;
 
    long long size_pred;
    fstream request_bin;

    request_bin.open("../FileBin/RequestBin.bin", ios::binary | ios::app);
    request_bin.close();

    request_bin.open("../FileBin/RequestBin.bin", ios::binary | ios::in);
    request_bin.seekg(0, ios::end);
    size_pred = request_bin.tellg();
    request_bin.close();
    cout << "сервер начал работу" << endl;

    while (true) {
        fstream request_bin;
        request_bin.open("../FileBin/RequestBin.bin", ios::binary | ios::in);
        request_bin.seekg(0, ios::end);
        while (size_pred >= request_bin.tellg()) {
            Sleep(100);
            request_bin.seekg(0, ios::end);
        }
        request_bin.seekg(size_pred, ios::beg);
        request_bin.read((char*)&pers, sizeof(pers));
        size_pred = request_bin.tellg();
        request_bin.close();

        cout << "запрос получен" << endl;

        double IMT = pers.weight / ((0.01 * pers.height) * (0.01 * pers.height));
        if (IMT >= 18.5 && IMT < 25.0) {
            answer = 1;
        }
        else if (IMT < 18.5) {
            answer = 0;
        }
        else{
            answer = 2;
        }

        Sleep(100);
        fstream client_file;
        string path = "../FileBin/";
        string name(pers.name);
        path.append(name).append(".bin");
        client_file.open(path, ios::binary | ios::app);
        client_file.write((char*)&answer, sizeof(answer));
        client_file.close();
        cout << "рассчет IMT произведён" << endl;
    }
}
